**Reference metrics in metric filters**

Some metrics require multiple aggregations or dependencies on other metrics. For example, say you work at a SAAS company that sells a data transformation product and want to count activated account, where the definition of an activated account is an account with more than five data model runs.  

To express this metric in SQL I would first write a query to calculate the number of data model runs per account, then count the number of accounts who have >5 data model runs. 

```sql
with data_models_per_user as (
select
	 count(models_runs) as data_model_runs
	 , account_is as account
from 
	fct_model_runs
group by 
	2
),

select
	count(distinct account_id) as activated_accounts
from 
	dim_accounts 
	left join data_models_per_user on accounts.account_id = data_models_per_user.account
where 
	data_models_per_user.cnt_data_models >5
```

When calculating  activated_accounts, we are using the `data_model_runs` metric as a dimensions for the user entity, since we are filtering on the metric value scoped to the account entity. We can express this logic natively in the MetricFlow spec

**How to reference a metric in a metric filter**

We can recreate this pattern in MetricFlow by referencing a metric in the where filter for another metric using the `Metric()` object syntax. The function for referencing a metric takes a metric name and exactly one entity 

```yaml
{{Metric(metric_name, group_by=['entity'])}}  
```

Let’s use the same activated accounts metric as an example. First, I'll create two semantic models, `model_runs` and `accounts`. Next, I will create a measure and metric to count data model runs, and another measure to count users. I’ll also specify the foreign entity `account`  in the `model_runs` semantic model.

```yaml
semantic_models:
	- name: model_runs
	  ...
	  entities:
	    - name: model_run
	      type: primary
	    - name: account
	      type: foreign
		measures:
		 - name: data_model_runs
			 agg: sum
			 expr: 1
			 create_metric: true
	- name: accounts
	  ...
	  entities:
	    - name: account
	      type: primary
		measures:
		 - name: accounts
			 agg: sum
			 expr: 1
```

Now I can create the `Activated Accounts` metric by filtering accounts that have > 5 data model runs

```yaml
metrics:
 - name: activated_accounts
	 label: Activated Accounts
   type: simple
   type_params:
	   measure: accounts
	 filter: |
		 {{ Metric('data_model_runs', group_by=['account']) }} > 5
```

Let’s break down the SQL that will be generated from this metric definition when I run the following query from the CLI `dbt sl query --metrics activated_accounts` 

First, the filter `{{ Metric('data_models', group_by=['account']) }}` will generate SQL similar to the `data_models_per_user` sub query shown above.

```sql
select
  sum(1) as data_model_runs
  , account
 from data_model_runs
 group by 
	 account
```

We will then join this query to the query generated by the `accounts` measure on the group by elements and apply the filter conditions.

```sql
select
	sum(1) as activated_accounts
from accounts
left join (
select
    sum(1) as data_model_runs
  , account
 from data_model_runs
 group by 
	 account
) as subq
on accounts.account = subq.account
where data_model_runs > 5
	
```

The intermediate tables we would use to create this metric are:

Accounts with the `data_model_runs` dimension

| account | data_model runs |
| --- | --- |
| 1 | 4 |
| 2 | 7 |
| 3 | 9 |
| 4 | 1 |

We’ll filter the above table for  accounts with >5 data model runs, then count the number of accounts who meet this criteria.

| activated_accounts |
| --- |
| 2 |

**Restrictions when using metrics in filter**

- We must be able to join the metric filter sub query to the outer query without fanning out the results. In our example filtering the accounts measure by `{{ Metric('data_model_runs', group_by=['account']) }}` is valid since we’re aggregating model runs to the account level, but filtering by `{{ Metric('data_model_runs', group_by=['model']) }}` is not since there is a one to many relationship between accounts and model runs
- You can only group a metric by one entity. Support for grouping by multiple entities and dimensions is pending.